name: Update Formula

on:
  repository_dispatch:
    types: [new-release]
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., 0.1.0)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  update:
    name: Update Formula
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            VERSION="${{ github.event.client_payload.version }}"
          else
            VERSION="${{ inputs.version }}"
          fi
          # Remove 'v' prefix if present
          VERSION="${VERSION#v}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Version: ${VERSION}"

      - name: Download SHA256SUMS
        run: |
          curl -L -o SHA256SUMS.txt \
            "https://github.com/hooklistener/hooklistener-cli/releases/download/v${{ steps.version.outputs.version }}/SHA256SUMS.txt"
          cat SHA256SUMS.txt

      - name: Extract checksums
        id: checksums
        run: |
          SHA_MACOS_ARM=$(grep "aarch64-apple-darwin" SHA256SUMS.txt | awk '{print $1}')
          SHA_MACOS_INTEL=$(grep "x86_64-apple-darwin" SHA256SUMS.txt | awk '{print $1}')
          SHA_LINUX=$(grep "x86_64-unknown-linux-gnu" SHA256SUMS.txt | awk '{print $1}')

          echo "macos_arm=${SHA_MACOS_ARM}" >> "$GITHUB_OUTPUT"
          echo "macos_intel=${SHA_MACOS_INTEL}" >> "$GITHUB_OUTPUT"
          echo "linux=${SHA_LINUX}" >> "$GITHUB_OUTPUT"

          echo "macOS ARM: ${SHA_MACOS_ARM}"
          echo "macOS Intel: ${SHA_MACOS_INTEL}"
          echo "Linux: ${SHA_LINUX}"

      - name: Update formula
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          SHA_MACOS_ARM="${{ steps.checksums.outputs.macos_arm }}"
          SHA_MACOS_INTEL="${{ steps.checksums.outputs.macos_intel }}"
          SHA_LINUX="${{ steps.checksums.outputs.linux }}"

          cat > Formula/hooklistener.rb << 'EOF'
          # typed: false
          # frozen_string_literal: true

          class Hooklistener < Formula
            desc "Fast, terminal-based CLI for browsing webhooks, forwarding events, and HTTP tunneling"
            homepage "https://hooklistener.com"
            version "VERSION_PLACEHOLDER"
            license "MIT"

            on_macos do
              on_arm do
                url "https://github.com/hooklistener/hooklistener-cli/releases/download/v#{version}/hooklistener-cli-aarch64-apple-darwin.tar.gz"
                sha256 "SHA_MACOS_ARM_PLACEHOLDER"
              end
              on_intel do
                url "https://github.com/hooklistener/hooklistener-cli/releases/download/v#{version}/hooklistener-cli-x86_64-apple-darwin.tar.gz"
                sha256 "SHA_MACOS_INTEL_PLACEHOLDER"
              end
            end

            on_linux do
              on_intel do
                url "https://github.com/hooklistener/hooklistener-cli/releases/download/v#{version}/hooklistener-cli-x86_64-unknown-linux-gnu.tar.gz"
                sha256 "SHA_LINUX_PLACEHOLDER"
              end
            end

            def install
              bin.install "hooklistener-cli" => "hooklistener"
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/hooklistener --version")
            end
          end
          EOF

          # Replace placeholders with actual values
          sed -i "s/VERSION_PLACEHOLDER/${VERSION}/g" Formula/hooklistener.rb
          sed -i "s/SHA_MACOS_ARM_PLACEHOLDER/${SHA_MACOS_ARM}/g" Formula/hooklistener.rb
          sed -i "s/SHA_MACOS_INTEL_PLACEHOLDER/${SHA_MACOS_INTEL}/g" Formula/hooklistener.rb
          sed -i "s/SHA_LINUX_PLACEHOLDER/${SHA_LINUX}/g" Formula/hooklistener.rb

          echo "Updated formula:"
          cat Formula/hooklistener.rb

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/hooklistener.rb
          git commit -m "Update hooklistener to v${{ steps.version.outputs.version }}"
          git push
